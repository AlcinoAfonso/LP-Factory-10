name: Security Checks

on:
  pull_request:
    branches:
      - main
      - macro

permissions:
  contents: read

jobs:
  no-implicit-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block implicit flow patterns in client/UI
        shell: bash
        run: |
          set -euo pipefail

          # S√≥ escaneia diret√≥rios que existirem (evita erro/falso "pass")
          SCAN_PATHS=()
          [ -d "src" ] && SCAN_PATHS+=("src")
          [ -d "app" ] && SCAN_PATHS+=("app")

          if [ ${#SCAN_PATHS[@]} -eq 0 ]; then
            echo "‚ÑπÔ∏è Nenhum diret√≥rio src/ ou app/ encontrado. Nada para escanear."
            exit 0
          fi

          echo "üîé Scanning paths: ${SCAN_PATHS[*]}"

          # Bloqueia padr√µes proibidos em src/ e app/
          if grep -R -nE '#access_token|refresh_token|setSession\(|getSessionFromUrl\(' "${SCAN_PATHS[@]}"; then
            echo "‚ùå Forbidden implicit flow (tokens/setSession/getSessionFromUrl) found in client/UI."
            exit 1
          fi

          # verifyOtp s√≥ pode aparecer no handler server de confirm
          # Lista qualquer ocorr√™ncia fora de app/auth/confirm/**
          OFFENDERS="$(grep -R -n 'verifyOtp(' "${SCAN_PATHS[@]}" | grep -v 'app/auth/confirm/' || true)"
          if [ -n "$OFFENDERS" ]; then
            echo "‚ùå verifyOtp() found outside server confirm handler:"
            echo "$OFFENDERS"
            exit 1
          fi

          echo "‚úÖ Security scan passed."
