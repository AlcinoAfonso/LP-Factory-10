name: Security Checks

on:
  pull_request:
    branches: ["main", "macro"]

permissions:
  contents: read

jobs:
  no-implicit-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block implicit flow patterns in client/UI
        shell: bash
        run: |
          set -euo pipefail

          echo "# Bloqueia padr√µes proibidos em src/ e app/ (com log dos ofensores)"

          TARGETS=()
          [ -d "src" ] && TARGETS+=("src")
          [ -d "app" ] && TARGETS+=("app")

          if [ ${#TARGETS[@]} -eq 0 ]; then
            echo "‚ÑπÔ∏è Nenhum diret√≥rio src/ ou app/ encontrado. Nada para escanear."
            exit 0
          fi

          echo "üîé Scanning paths: ${TARGETS[*]}"

          # 1) Tokens/setSession/getSessionFromUrl N√ÉO podem aparecer em client/UI
          OFFENDERS="$(grep -R -n -E "access_token|refresh_token|setSession\(|getSessionFromUrl\(" "${TARGETS[@]}" || true)"
          if [ -n "$OFFENDERS" ]; then
            echo "‚ùå Forbidden implicit flow (tokens/setSession/getSessionFromUrl) found in client/UI:"
            echo "$OFFENDERS"
            exit 1
          fi

          # 2) verifyOtp s√≥ pode aparecer em app/auth/confirm/**
          OTP_OFFENDERS="$(grep -R -n "verifyOtp(" "${TARGETS[@]}" | grep -v "app/auth/confirm/" || true)"
          if [ -n "$OTP_OFFENDERS" ]; then
            echo "‚ùå verifyOtp() found outside server confirm handler:"
            echo "$OTP_OFFENDERS"
            exit 1
          fi

          echo "‚úÖ no-implicit-flow OK"
