name: Security Checks

on:
  pull_request:
    branches:
      - main
      - macro

permissions:
  contents: read

jobs:
  no-implicit-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block implicit flow patterns in client/UI
        shell: bash
        run: |
          set -euo pipefail

          # Só varre diretórios que existem (evita erro/falso fail)
          SCAN_PATHS=()
          [ -d "src" ] && SCAN_PATHS+=("src")
          [ -d "app" ] && SCAN_PATHS+=("app")

          if [ "${#SCAN_PATHS[@]}" -eq 0 ]; then
            echo "ℹ️ No src/ or app/ directory found; skipping client/UI checks."
            exit 0
          fi

          # 1) Bloqueia implicit flow patterns em client/UI (exceto confirm server)
          FORBIDDEN_REGEX='(#access_token|refresh_token|setSession\(|getSessionFromUrl\()'
          MATCHES=$(grep -R -nE "$FORBIDDEN_REGEX" "${SCAN_PATHS[@]}" 2>/dev/null | grep -v "app/auth/confirm/" || true)

          if [ -n "$MATCHES" ]; then
            echo "❌ Forbidden implicit flow (tokens/setSession/getSessionFromUrl) found in client/UI."
            echo "$MATCHES"
            exit 1
          fi

          # 2) verifyOtp() só pode aparecer no handler server de confirm (app/auth/confirm/**)
          OFFENDERS=$(grep -R -n "verifyOtp(" "${SCAN_PATHS[@]}" 2>/dev/null | grep -v "app/auth/confirm/" || true)

          if [ -n "$OFFENDERS" ]; then
            echo "❌ verifyOtp() found outside server confirm handler (app/auth/confirm/**):"
            echo "$OFFENDERS"
            exit 1
          fi

          echo "✅ Security checks passed."
