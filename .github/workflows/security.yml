name: Security Checks

on:
  pull_request:
    branches: [ "main", "macro" ]

jobs:
  no-implicit-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Block implicit flow patterns in client/UI
        run: |
          # Bloqueia padrões proibidos em src/ e app/, exceto o confirm server
          ! grep -R -nE "#access_token|refresh_token|setSession\\(|getSessionFromUrl\\(" src/ app/ || (
            echo "❌ Forbidden implicit flow (tokens/setSession/getSessionFromUrl) found in client/UI." && exit 1
          )
          # verifyOtp só pode aparecer no handler server de confirm
          # Lista qualquer ocorrência fora de app/auth/confirm/**
          OFFENDERS=$(grep -R -n "verifyOtp(" src/ app/ | grep -v "app/auth/confirm/")
          if [ -n "$OFFENDERS" ]; then
            echo "❌ verifyOtp() found outside server confirm handler:"
            echo "$OFFENDERS"
            exit 1
          fi
