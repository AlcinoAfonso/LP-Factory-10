name: Security Checks

on:
  pull_request:
    branches: ["main", "macro"]

jobs:
  no-implicit-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Block implicit flow patterns in client/UI
        shell: bash
        run: |
          set -euo pipefail

          echo "# Bloqueia padrões proibidos em src/ e app/, exceto o confirm server"

          # Alvos existentes (evita erro se src/ não existir)
          TARGETS=()
          [ -d "src" ] && TARGETS+=("src")
          [ -d "app" ] && TARGETS+=("app")

          if [ ${#TARGETS[@]} -eq 0 ]; then
            echo "No src/ or app/ folders found; skipping."
            exit 0
          fi

          # 1) Tokens/setSession/getSessionFromUrl NUNCA podem aparecer em client/UI
          OFFENDERS="$(grep -R -n -E "access_token|refresh_token|setSession\(|getSessionFromUrl\(" "${TARGETS[@]}" || true)"
          if [ -n "$OFFENDERS" ]; then
            echo "❌ Forbidden implicit flow (tokens/setSession/getSessionFromUrl) found in client/UI:"
            echo "$OFFENDERS"
            exit 1
          fi

          # 2) verifyOtp só pode aparecer no handler server de confirm
          OTP_OFFENDERS="$(grep -R -n "verifyOtp(" "${TARGETS[@]}" | grep -v "app/auth/confirm/" || true)"
          if [ -n "$OTP_OFFENDERS" ]; then
            echo "❌ verifyOtp() found outside server confirm handler:"
            echo "$OTP_OFFENDERS"
            exit 1
          fi

          echo "✅ no-implicit-flow OK"
